using System.Collections.Generic;
using UnityEngine;

namespace AmbulanceRaceGame
{
    public class GameManager : Singleton<GameManager>
    {
        [SerializeField] private GameObject roadPrefab;
        [SerializeField] private float spawnPosZ;

        public float[] lanesX = { -3f, -1f, 1f, 3f };

        public int maxSpawnObstacles;

        [HideInInspector] public bool isEndGame;

        public float scoreRate;
        [HideInInspector] public float currentScore;

        public List<Road> roads = new List<Road>();
        [HideInInspector] public float currentMoveSpeed;

        protected override void Awake()
        {
            MakeSingleton(false);
        }

        void Start()
        {
            currentScore = 0;
            UpdateSpeedByScore();
        }

        public void SpawnRoad()
        {
            GameObject roadClone = Instantiate(
                roadPrefab,
                new Vector3(roadPrefab.transform.position.x,
                            roadPrefab.transform.position.y,
                            spawnPosZ),
                Quaternion.identity);

            Road road = roadClone.GetComponent<Road>();
            roads.Add(road);

            UpdateSpeedByScore();

            for (int i = 0; i < roads.Count; i++)
            {
                roads[i].moveSpeed = currentMoveSpeed;
            }
        }

        void UpdateSpeedByScore()
        {
            if (currentScore <= 10f)
            {
                currentMoveSpeed = 2f;
                maxSpawnObstacles = 3;
            }
            else if (currentScore > 10f && currentScore <= 20f)
            {
                currentMoveSpeed = 3f;
                maxSpawnObstacles = 4;
            }
            else if (currentScore > 20f && currentScore <= 30f)
            {
                currentMoveSpeed = 4f;
                maxSpawnObstacles = 5;
            }
            else if (currentScore > 30f && currentScore <= 40f)
            {
                currentMoveSpeed = 5f;
                maxSpawnObstacles = 6;
            }
            else
            {
                currentMoveSpeed = 7f;
                maxSpawnObstacles = 8;
            }
        }

        public void UpdateScore()
        {
            currentScore += Time.deltaTime * scoreRate;
            GuiManager.Ins.UpdateScoreText((int)currentScore);

            UpdateSpeedByScore();

            for (int i = 0; i < roads.Count; i++)
            {
                roads[i].moveSpeed = currentMoveSpeed;
            }
        }
    }
}


using UnityEngine;

namespace AmbulanceRaceGame
{
    public class ObstacleCar : MonoBehaviour
    {
        [SerializeField] private float minExtraSpeed = -1f;   
        [SerializeField] private float maxExtraSpeed = 1.5f;  
        [SerializeField] private float destroyZ = -30f;       

        float extraSpeed;  

        public void InitRandomExtraSpeed()
        {
            extraSpeed = Random.Range(minExtraSpeed, maxExtraSpeed);
        }

        void Update()
        {
            if (GameManager.Ins.isEndGame) return;

            float speed = GameManager.Ins.currentMoveSpeed + extraSpeed;

            // di chuyển độc lập trong World space
            transform.Translate(0f, 0f, -speed * Time.deltaTime, Space.World);

            if (transform.position.z < destroyZ)
            {
                Destroy(gameObject);
            }
        }
    }
}


using UnityEngine;

namespace AmbulanceRaceGame
{
    public class Road : MonoBehaviour
    {
        public float moveSpeed;
        [SerializeField] private float resetZ = -20f;

        [SerializeField] private GameObject[] obstaclePrefabs;

        bool isSpawned;

        void Start()
        {
            SpawnObstacle();
        }

        void Update()
        {
            if (GameManager.Ins.isEndGame) return;

            Move();
        }

        void Move()
        {
            transform.Translate(0, 0, -moveSpeed * Time.deltaTime);

            if (transform.position.z < resetZ && !isSpawned)
            {
                GameManager.Ins.SpawnRoad();
                isSpawned = true;
            }

            if (transform.position.z < -30f)
            {
                GameManager.Ins.roads.Remove(gameObject.GetComponent<Road>());
                Destroy(gameObject);
            }
        }

        void SpawnObstacle()
        {
            for (int i = 0; i < GameManager.Ins.maxSpawnObstacles; i++)
            {
                int randomLane = Random.Range(0, GameManager.Ins.lanesX.Length);

                Vector3 pos = new Vector3(
                    GameManager.Ins.lanesX[randomLane],
                    0.904f,
                    transform.position.z + Random.Range(5f, 10f)
                );

                GameObject obs = Instantiate(
                    obstaclePrefabs[Random.Range(0, obstaclePrefabs.Length)],
                    pos,
                    Quaternion.identity
                );

                ObstacleCar car = obs.GetComponent<ObstacleCar>();
                if (car != null)
                {
                    car.InitRandomExtraSpeed();
                }
            }
        }
    }
}
